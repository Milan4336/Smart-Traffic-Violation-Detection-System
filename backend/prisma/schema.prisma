generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String     @id @default(uuid())
  name            String
  email           String     @unique
  passwordHash    String
  role            String     // admin, officer, analyst
  clearanceLevel  Int        // 1, 2, 3, 4
  createdAt       DateTime   @default(now())
  lastLogin       DateTime?
  auditLogs       AuditLog[]
  verifiedViolations Violation[] @relation("VerifiedBy")
  uploadedVideos  UploadedVideo[]
}

model Violation {
  id               String   @id @default(uuid())
  type             String
  plateNumber      String?
  vehicleType      String?
  confidenceScore  Float
  threatScore      Float    @default(0)
  cameraId         String
  locationLat      Float?
  locationLng      Float?
  evidenceImageUrl String?
  evidenceVideoUrl String?
  status           String   @default("pending") // pending, verified, rejected, dispatched
  createdAt        DateTime @default(now())
  verifiedBy       String?
  verifiedAt       DateTime?
  
  fineAmount       Int?
  fineStatus       String?   @default("pending") // pending, paid, waived
  fineGeneratedAt  DateTime? @default(now())

  camera           Camera   @relation(fields: [cameraId], references: [id])
  verifier         User?    @relation("VerifiedBy", fields: [verifiedBy], references: [id])
  alerts           Alert[]
  vehicle          Vehicle? @relation(fields: [plateNumber], references: [plateNumber])
}

model Camera {
  id            String   @id @default(uuid())
  name          String
  rtspUrl       String?  // New field for Real Cameras
  locationLat   Float
  locationLng   Float
  status        String   @default("ONLINE") // ONLINE, OFFLINE, MAINTENANCE (Admin status)
  healthStatus  String   @default("HEALTHY") // HEALTHY, DEGRADED, OFFLINE (Technical status)
  lastHeartbeat DateTime @default(now())
  
  currentFps    Float?
  latencyMs     Int?
  failureCount  Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  violations    Violation[]
  metrics       CameraMetricsDaily[]
}

model Alert {
  id             String    @id @default(uuid())
  violationId    String
  cameraId       String?
  plateNumber    String?
  alertType      String    // CRITICAL, HIGH, MEDIUM
  status         String    @default("ACTIVE") // ACTIVE, ACKNOWLEDGED, RESOLVED
  
  acknowledgedAt DateTime?
  resolvedAt     DateTime?
  createdAt      DateTime  @default(now())

  violation      Violation @relation(fields: [violationId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}

// ============================================
// ENTERPRISE SYSTEM UPDATES & PATCH TRACKING
// ============================================

model SystemVersion {
  id             String   @id @default(uuid())
  versionNumber  String   @unique // e.g., v1.3.0
  releaseName    String
  releaseType    String   // major, minor, patch, hotfix
  releaseDate    DateTime?
  releaseStatus  String   @default("draft") // draft, scheduled, released
  createdBy      String
  createdAt      DateTime @default(now())

  patchNotes     PatchNote[]
  changelogs     SystemChangelog[]
}

model PatchNote {
  id          String   @id @default(uuid())
  versionId   String
  title       String
  description String
  category    String   // feature, improvement, fix, security, performance
  severity    String   // low, medium, high, critical
  component   String   // frontend, backend, AI, database, security, camera, analytics
  createdAt   DateTime @default(now())

  version     SystemVersion @relation(fields: [versionId], references: [id])
}

model SystemChangelog {
  id             String   @id @default(uuid())
  versionId      String?
  changeType     String   // e.g., ADD_CAMERA, SECURITY_CHANGE
  affectedModule String
  oldValue       String?
  newValue       String?
  changedBy      String
  createdAt      DateTime @default(now())

  version        SystemVersion? @relation(fields: [versionId], references: [id])
}

model SystemMetadata {
  id             String   @id @default(uuid())
  currentVersion String
  lastUpdated    DateTime @default(now())
  environment    String   @default("production")
  buildNumber    Int      @default(1)
}

model UploadedVideo {
  id              String   @id @default(uuid())
  uploadedBy      String
  filePath        String
  status          String   @default("queued") // queued, processing, completed, failed
  durationSeconds Float?
  uploadedAt      DateTime @default(now())
  processedAt     DateTime?

  user            User     @relation(fields: [uploadedBy], references: [id])
  violations      VideoViolation[]
}

model VideoViolation {
  id                 String   @id @default(uuid())
  videoId            String
  violationType      String
  confidenceScore    Float
  frameTimestamp     Float
  plateNumber        String?
  boundingBox        Json?
  evidenceImagePath  String?
  createdAt          DateTime @default(now())
  
  fineAmount         Int?
  fineStatus         String?   @default("pending") // pending, paid, waived
  fineGeneratedAt    DateTime? @default(now())

  video              UploadedVideo @relation(fields: [videoId], references: [id])
  vehicle            Vehicle?      @relation(fields: [plateNumber], references: [plateNumber])
}

model Vehicle {
  id               String   @id @default(uuid())
  plateNumber      String   @unique
  totalViolations  Int      @default(0)
  riskLevel        String   @default("LOW") // LOW, MEDIUM, HIGH, CRITICAL
  isBlacklisted    Boolean  @default(false)
  lastViolationAt  DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  violations       Violation[]
  videoViolations  VideoViolation[]
}

model CameraMetricsDaily {
  id               String   @id @default(uuid())
  cameraId         String
  date             DateTime @default(now())
  uptimePercentage Float
  avgFps           Float
  avgLatency       Int
  
  camera           Camera   @relation(fields: [cameraId], references: [id])
  
  @@unique([cameraId, date])
}

model ViolationFineRule {
  id               String   @id @default(uuid())
  violationType    String   @unique // e.g., NO_HELMET, RED_LIGHT
  baseAmount       Int
  repeatMultiplier Float    @default(1.0)
  createdAt        DateTime @default(now())
}
